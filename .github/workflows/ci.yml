name: CI

on:
  pull_request:
    branches: [ "main" ]

jobs:
  prerequisites:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: install dependencies
      run: make install

  compile_kernel:

    needs: prerequisites
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: install dependencies
      run: make install

    - name: compile kernel
      run: make
  
  checkpatch:

    runs-on: ubuntu-latest

    steps:

    - uses: actions/checkout@v4

    - name: install dependencies
      run: make install-ci

    - name: Run checkpatch on PR commits
      run: |
        BASE_SHA="${{ github.event.pull_request.base.sha }}"
        HEAD_SHA="${{ github.event.pull_request.head.sha }}"

        # Fetch the base commit explicitly
        git fetch origin "$BASE_SHA" || true

        # Ensure HEAD exists locally (it does via checkout)
        git fetch origin "$HEAD_SHA" || true

        echo "Generating patch for PR commits..."
        git format-patch --stdout "$BASE_SHA".."$HEAD_SHA" > pr.patch

        tools/scripts/checkpatch.pl \
          --no-tree \
          --strict \
          --show-types \
          --color=never \
          --ignore MAINTAINERS \
          --ignore FILE_PATH_CHANGES \
          --ignore BAD_SIGN_OFF \
          pr.patch
